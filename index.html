<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Infinity · Admin + Builder (single file)</title>
  <meta name="color-scheme" content="light dark"/>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --danger: #f43f5e;
      --good: #22c55e;
      --radius: 14px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      background: radial-gradient(circle at top, #0f172a 10%, #020617 50%, #020617 100%);
      color:#e2e8f0;
      font-family:var(--font);
      min-height:100vh;
    }
    header {
      background:rgba(2,6,23,.6);
      border-bottom:1px solid rgba(148,163,184,.15);
      backdrop-filter:blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      position:sticky;
      top:0;
      z-index:10;
    }
    .logo {
      font-weight:800;
      font-size:1.1rem;
      letter-spacing:.04em;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .badge { background:rgba(56,189,248,.12); border:1px solid rgba(56,189,248,.35); padding:4px 10px; border-radius:999px; font-size:.65rem; }
    main { max-width:1200px; margin:0 auto; padding:24px 16px 80px; display:grid; grid-template-columns: minmax(0, 1.4fr) minmax(0, .6fr); gap:20px; }
    .card {
      background:rgba(15,23,42,.35);
      border:1px solid rgba(148,163,184,.08);
      border-radius:var(--radius);
      padding:16px 16px 14px;
      backdrop-filter:blur(8px);
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }
    h2 { margin:0 0 10px; font-size:1rem; }
    p.muted { margin:0 0 12px; color:var(--muted); font-size:.78rem; }
    label { display:block; font-size:.7rem; margin-top:9px; margin-bottom:3px; color:rgba(226,232,240,.85); }
    input, textarea, select {
      width:100%;
      background:rgba(15,23,42,.2);
      border:1px solid rgba(148,163,184,.25);
      border-radius:10px;
      padding:7px 9px;
      color:#e2e8f0;
      font-family:inherit;
      font-size:.78rem;
    }
    textarea { min-height:90px; resize:vertical; }
    button {
      background:linear-gradient(135deg, #38bdf8, #0ea5e9);
      border:none;
      border-radius:999px;
      padding:7px 16px 7px;
      color:#0f172a;
      font-weight:700;
      margin-top:10px;
      cursor:pointer;
      font-size:.72rem;
    }
    button.secondary {
      background:rgba(15,23,42,.1);
      border:1px solid rgba(148,163,184,.19);
      color:#e2e8f0;
    }
    .two { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .list {
      border:1px solid rgba(148,163,184,.13);
      border-radius:10px;
      max-height:210px;
      overflow-y:auto;
      background:rgba(15,23,42,.35);
      margin-top:8px;
    }
    .list-item {
      padding:6px 10px;
      border-bottom:1px solid rgba(148,163,184,.04);
      font-size:.7rem;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .list-item:last-child { border-bottom:none; }
    .pill { background:rgba(148,163,184,.1); border:1px solid rgba(148,163,184,.1); border-radius:999px; padding:1px 8px; font-size:.6rem; }
    .admin-only { border:1px solid rgba(250,250,250,.1); }
    .hidden { display:none !important; }
    .terminal {
      background:rgba(2,6,23,.3);
      border:1px solid rgba(148,163,184,.12);
      border-radius:12px;
      overflow:hidden;
      height:210px;
      display:flex;
      flex-direction:column;
    }
    .terminal-head { background:rgba(2,6,23,.4); padding:5px 10px; font-size:.65rem; display:flex; align-items:center; gap:5px; }
    .dot { width:8px; height:8px; border-radius:50%; }
    .d-red { background:#f43f5e; }
    .d-yellow { background:#f59e0b; }
    .d-green { background:#22c55e; }
    .terminal-body { flex:1; overflow-y:auto; padding:6px 10px; font-family: ui-monospace, SFMono-Regular, SFMono-Regular, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.65rem; line-height:1.4; }
    .terminal-input { display:flex; gap:6px; padding:7px 10px 10px; }
    .terminal-input input { flex:1; font-family:inherit; }
    .status { margin-top:6px; font-size:.7rem; }
    .ok { color:var(--good); }
    .err { color:var(--danger); }
    @media (max-width:900px){
      main { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <span>INFINITY</span>
      <span class="badge" id="login-indicator">not logged in</span>
    </div>
    <div style="display:flex; gap:8px;">
      <input id="login-name" placeholder="login as..." style="width:140px;"/>
      <button onclick="doLogin()">Login</button>
    </div>
  </header>

  <main>
    <!-- LEFT: user visible -->
    <section>
      <div class="card">
        <h2>Uploader / Collector</h2>
        <p class="muted">Drop files here. We store them in browser storage. We do <b>not</b> delete previous ones.</p>
        <input type="file" id="file-input" multiple onchange="handleFiles(this.files)">
        <label for="free-text">or paste script / notes</label>
        <textarea id="free-text" placeholder="paste HTML / JS / notes / user profile ..."></textarea>
        <button onclick="saveFreeText()">Add to repository</button>
        <div class="status" id="upload-status"></div>

        <h3 style="font-size:.75rem;margin-top:14px;">Stored Items (local)</h3>
        <div class="list" id="repo-list"></div>
      </div>

      <div class="card">
        <h2>Terminal / Builder</h2>
        <p class="muted">Talk to your page. We’ll store each command as an event and make “generated scripts” out of it.</p>
        <div class="terminal" id="term">
          <div class="terminal-head">
            <div class="dot d-red"></div>
            <div class="dot d-yellow"></div>
            <div class="dot d-green"></div>
            <span style="margin-left:6px;">/infinity/agent</span>
          </div>
          <div class="terminal-body" id="term-body"></div>
          <div class="terminal-input">
            <input id="term-input" placeholder="ex: build landing page with gallery" onkeydown="if(event.key==='Enter'){runTerminal();}"/>
            <button onclick="runTerminal()">Run</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: admin, github, knowledge -->
    <section>
      <div class="card admin-only hidden" id="admin-panel">
        <h2>Admin (Kris)</h2>
        <p class="muted">This pane only appears when logged in as <b>Kris</b>. Everyone else can’t see it.</p>

        <label>GitHub Personal Access Token</label>
        <input id="gh-token" placeholder="paste token here (we store locally)">

        <div class="two">
          <div>
            <label>Owner</label>
            <input id="gh-owner" placeholder="your-github-name">
          </div>
          <div>
            <label>Repo</label>
            <input id="gh-repo" placeholder="your-repo">
          </div>
        </div>

        <label>Path in repo</label>
        <input id="gh-path" value="admin/collected/activity.json">

        <label>Content to push</label>
        <textarea id="gh-content" placeholder="click 'Build content from storage' below"></textarea>

        <button onclick="buildContentFromStorage()">Build content from storage</button>
        <button onclick="commitToGithub()">Push to GitHub</button>
        <div class="status" id="gh-status"></div>

        <p class="muted" style="margin-top:12px;">
          To get a token: GitHub → Settings → Developer settings → Personal access tokens (classic) → New token → tick <b>repo</b> → copy.  
          You only do this once. We keep it in localStorage on this machine.
        </p>
      </div>

      <div class="card">
        <h2>Knowledge Base (live)</h2>
        <p class="muted">We rebuild this from whatever is in localStorage. Nothing is deleted.</p>
        <button class="secondary" onclick="rebuildKnowledge()">Rebuild KB</button>
        <div class="status" id="kb-status"></div>
        <div id="kb-preview" style="font-size:.67rem;white-space:pre-wrap;margin-top:6px;max-height:180px;overflow-y:auto;"></div>
      </div>
    </section>
  </main>

  <script>
    // ========= STORAGE KEYS (never deleting by default) =========
    const KEY_FILES   = 'infinity_files';      // array of {name, type, content, ts}
    const KEY_TEXT    = 'infinity_text_snips'; // array of {content, ts}
    const KEY_EVENTS  = 'infinity_events';     // array of {cmd, ts, generated?}
    const KEY_USER    = 'infinity_user';
    const KEY_GH      = 'infinity_admin_token';

    // ========= INIT =========
    (function init(){
      const u = localStorage.getItem(KEY_USER);
      if (u) setLoginUI(u);
      renderRepoList();
      rebuildKnowledge();
      // restore token into field if admin
      if (u === 'Kris') {
        document.getElementById('admin-panel').classList.remove('hidden');
        const tok = localStorage.getItem(KEY_GH);
        if (tok) document.getElementById('gh-token').value = tok;
      }
    })();

    // ========= LOGIN =========
    function doLogin(){
      const name = document.getElementById('login-name').value.trim();
      if (!name) return;
      localStorage.setItem(KEY_USER, name);
      setLoginUI(name);
      if (name === 'Kris') {
        document.getElementById('admin-panel').classList.remove('hidden');
        const tok = localStorage.getItem(KEY_GH);
        if (tok) document.getElementById('gh-token').value = tok;
      } else {
        document.getElementById('admin-panel').classList.add('hidden');
      }
    }
    function setLoginUI(name){
      document.getElementById('login-indicator').textContent = 'signed in as '+name;
    }

    // ========= FILE UPLOAD =========
    function handleFiles(fileList){
      if (!fileList || !fileList.length) return;
      const arr = JSON.parse(localStorage.getItem(KEY_FILES) || '[]');
      let pending = fileList.length;
      for (const file of fileList) {
        const reader = new FileReader();
        reader.onload = e => {
          arr.push({
            name: file.name,
            type: file.type || 'text/plain',
            content: e.target.result,
            ts: Date.now()
          });
          pending--;
          if (pending === 0) {
            localStorage.setItem(KEY_FILES, JSON.stringify(arr));
            document.getElementById('upload-status').textContent = 'stored '+fileList.length+' file(s) — nothing was deleted.';
            renderRepoList();
            rebuildKnowledge();
          }
        };
        reader.readAsText(file);
      }
    }

    // ========= FREE TEXT SAVE =========
    function saveFreeText(){
      const val = document.getElementById('free-text').value.trim();
      if (!val) return;
      const arr = JSON.parse(localStorage.getItem(KEY_TEXT) || '[]');
      arr.push({content: val, ts: Date.now()});
      localStorage.setItem(KEY_TEXT, JSON.stringify(arr));
      document.getElementById('upload-status').textContent = 'text snippet saved. total: '+arr.length;
      document.getElementById('free-text').value = '';
      renderRepoList();
      rebuildKnowledge();
    }

    // ========= RENDER REPO =========
    function renderRepoList(){
      const files = JSON.parse(localStorage.getItem(KEY_FILES) || '[]');
      const texts = JSON.parse(localStorage.getItem(KEY_TEXT)  || '[]');
      const box = document.getElementById('repo-list');
      let html = '';
      files.forEach(f => {
        html += `<div class="list-item"><span>${f.name}</span><span class="pill">file</span></div>`;
      });
      texts.forEach((t,i) => {
        html += `<div class="list-item"><span>snippet-${i+1}</span><span class="pill">text</span></div>`;
      });
      box.innerHTML = html || '<div class="list-item">empty</div>';
    }

    // ========= TERMINAL / BUILDER =========
    function runTerminal(){
      const input = document.getElementById('term-input');
      const cmd = input.value.trim();
      if (!cmd) return;
      appendTerm('> '+cmd);
      input.value = '';

      // store event
      const events = JSON.parse(localStorage.getItem(KEY_EVENTS) || '[]');
      const evt = {cmd, ts: Date.now()};
      events.push(evt);
      localStorage.setItem(KEY_EVENTS, JSON.stringify(events));

      // FAKE "script builder" – builds HTML skeleton from prompt
      const generated = buildHtmlFromPrompt(cmd);
      appendTerm(generated);
      // also store generated into text-snips
      const texts = JSON.parse(localStorage.getItem(KEY_TEXT) || '[]');
      texts.push({content: generated, ts: Date.now()});
      localStorage.setItem(KEY_TEXT, JSON.stringify(texts));
      renderRepoList();
      rebuildKnowledge();
    }
    function appendTerm(line){
      const body = document.getElementById('term-body');
      const div = document.createElement('div');
      div.textContent = line;
      body.appendChild(div);
      body.scrollTop = body.scrollHeight;
    }
    function buildHtmlFromPrompt(cmd){
      // super simple block so it doesn't stay "thin"
      return [
        "[builder] generated chunk:",
        "<section class='infinity-block'>",
        "  <h2>"+cmd.replace(/</g,'&lt;')+"</h2>",
        "  <p>auto-generated by page agent at "+new Date().toISOString()+"</p>",
        "  <div class='slot'>attach media / uploads / ai stream here</div>",
        "</section>"
      ].join("\n");
    }

    // ========= KB REBUILD =========
    function rebuildKnowledge(){
      const files = JSON.parse(localStorage.getItem(KEY_FILES) || '[]');
      const texts = JSON.parse(localStorage.getItem(KEY_TEXT)  || '[]');
      const events = JSON.parse(localStorage.getItem(KEY_EVENTS) || '[]');

      const kb = {
        summary: "local kb built at "+new Date().toISOString(),
        fileCount: files.length,
        textCount: texts.length,
        eventCount: events.length,
        files: files.map(f => ({name:f.name, ts:f.ts})),
        lastText: texts.slice(-3),
        lastEvents: events.slice(-3)
      };
      document.getElementById('kb-status').textContent = 'KB rebuilt: '+files.length+' files, '+texts.length+' text, '+events.length+' events.';
      document.getElementById('kb-preview').textContent = JSON.stringify(kb, null, 2);
    }

    // ========= GITHUB =========
    async function commitToGithub(){
      const user = localStorage.getItem(KEY_USER) || '';
      if (user !== 'Kris') {
        document.getElementById('gh-status').textContent = '❌ only Kris can push';
        return;
      }
      const token = document.getElementById('gh-token').value.trim();
      const owner = document.getElementById('gh-owner').value.trim();
      const repo  = document.getElementById('gh-repo').value.trim();
      const path  = document.getElementById('gh-path').value.trim();
      const content = document.getElementById('gh-content').value;

      if (!token || !owner || !repo || !path) {
        document.getElementById('gh-status').textContent = '❌ missing token/owner/repo/path';
        return;
      }

      // persist token so you don’t have to paste again
      localStorage.setItem(KEY_GH, token);

      document.getElementById('gh-status').textContent = 'checking github…';
      try {
        const existing = await githubGetFile(token, owner, repo, path);
        const sha = existing ? existing.sha : null;
        document.getElementById('gh-status').textContent = existing ? 'updating file…' : 'creating file…';
        const res = await githubPutFile(token, owner, repo, path, content, sha);
        document.getElementById('gh-status').textContent = '✅ pushed to '+res.content.path;
      } catch (e) {
        document.getElementById('gh-status').textContent = '❌ '+e.message;
      }
    }

    async function githubGetFile(token, owner, repo, path){
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`;
      const res = await fetch(url, {
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github+json"
        }
      });
      if (res.status === 404) return null;
      if (!res.ok) throw new Error('GET '+res.status);
      return await res.json();
    }

    async function githubPutFile(token, owner, repo, path, content, sha=null){
      const body = {
        message: "infinity auto commit: "+path,
        content: btoa(unescape(encodeURIComponent(content)))
      };
      if (sha) body.sha = sha;
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github+json"
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error('PUT '+res.status+' '+txt);
      }
      return await res.json();
    }

    function buildContentFromStorage(){
      const files = JSON.parse(localStorage.getItem(KEY_FILES) || '[]');
      const texts = JSON.parse(localStorage.getItem(KEY_TEXT)  || '[]');
      const events = JSON.parse(localStorage.getItem(KEY_EVENTS) || '[]');

      // we append, we don't delete
      const payload = {
        collectedAt: new Date().toISOString(),
        files,
        texts,
        events
      };
      document.getElementById('gh-content').value = JSON.stringify(payload, null, 2);
      document.getElementById('gh-status').textContent = 'built content from storage, ready to push.';
    }
  </script>
</body>
</html>
